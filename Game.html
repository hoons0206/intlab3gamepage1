<!DOCTYPE html>
<html>
<head>
  <title>1P 화면</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="style3.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4d7JvLj90ar0Q8o_AEXFTjhMZF-oI-DU",
      authDomain: "interaction-lab-3-c4513.firebaseapp.com",
      databaseURL: "https://interaction-lab-3-c4513-default-rtdb.firebaseio.com",
      projectId: "interaction-lab-3-c4513",
      storageBucket: "interaction-lab-3-c4513.appspot.com",
      messagingSenderId: "40397314576",
      appId: "1:40397314576:web:b6bbbeb99fd43bda508895"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>

<div id="color-sequence-display"></div>

<div id="timer-bar-container">
  <div id="timer-bar"></div>
</div>

<div class="buttons" style="text-align:center; margin-top: 20px;">
  <button class="start-button" data-type="type1">빨강</button>
  <button class="start-button" data-type="type2">초록</button>
  <button class="start-button" data-type="type3">파랑</button>
  <button class="start-button" data-type="type4">노랑</button>
</div>

<div id="conveyor"></div>

<script>
  const conveyor = document.getElementById('conveyor');
  const types = ['type1', 'type2', 'type3', 'type4'];
  const boxWidth = 70;
  const boxes = [];
  let selectedType = null;
  const speed = 3;
  const spawnDelay = 3 * 1000;
  const spawnInterval = 90;
  let spawnTimer = 0;
  let gameStarted = false;

  const incomingBoxesRef = db.ref('game/2p_incomingBoxes');

  const imgMap = {
    'type1': ['html/media/red1.png', 'html/media/red2.png'],
    'type2': ['html/media/green1.png', 'html/media/green2.png'],
    'type3': ['html/media/blue1.png', 'html/media/blue2.png'],
    'type4': ['html/media/yellow1.png', 'html/media/yellow2.png']
  };

  function getRandomType() {
    return types[Math.floor(Math.random() * types.length)];
  }

  function createBox() {
    const boxId = `box${Date.now()}`;
    const imgEl = document.createElement('img');
    imgEl.classList.add('box-img');
    imgEl.setAttribute('data-id', boxId);
    imgEl.style.left = -boxWidth + 'px';

    const randomType = getRandomType();
    imgEl.dataset.type = randomType;
    imgEl.dataset.state = '1'; // 초기 상태
    imgEl.src = imgMap[randomType][0];

    conveyor.appendChild(imgEl);

    const boxObj = {
      id: boxId,
      el: imgEl,
      left: -boxWidth,
      type: randomType
    };

    imgEl.addEventListener('click', () => {
      if (selectedType && selectedType === boxObj.type) {
        if (imgEl.dataset.state === '1') {
          imgEl.src = imgMap[boxObj.type][1];
          imgEl.dataset.state = '2';
        } else {
          imgEl.src = imgMap[boxObj.type][0];
          imgEl.dataset.state = '1';
        }
      }
    });

    boxes.push(boxObj);
  }

  document.querySelectorAll('.start-button').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedType = btn.dataset.type;
    });
  });

  setTimeout(() => {
    gameStarted = true;
  }, spawnDelay);

  let gaugeInterval; // ⬅️ 전역으로 선언

  setInterval(() => {
    if (!gameStarted) return;

    spawnTimer++;
    if (spawnTimer >= spawnInterval) {
      createBox();
      spawnTimer = 0;
    }

    for (let i = boxes.length - 1; i >= 0; i--) {
      const box = boxes[i];
      box.left += speed;
      box.el.style.left = box.left + 'px';

      if (box.left > window.innerWidth) {
        if (box.el.dataset.state === '1') {
          clearInterval(gaugeInterval); // ✅ 성공 타이머 중단
          window.location.href = 'Fail.html';
          return;
        }

        incomingBoxesRef.push({
          type: box.type,
          state: box.el.dataset.state,
          timestamp: Date.now()
        });

        box.el.remove();
        boxes.splice(i, 1);
      }
    }
  }, 1000 / 30);

  const timerBar = document.getElementById('timer-bar');
  let gaugeStartTime = Date.now();
  const gaugeDuration = 30 * 1000; // 30초

  gaugeInterval = setInterval(() => {
    const elapsed = Date.now() - gaugeStartTime;
    const percent = Math.min(100, (elapsed / gaugeDuration) * 100);
    timerBar.style.width = percent + '%';

    if (elapsed >= gaugeDuration) {
      clearInterval(gaugeInterval);
      window.location.href = 'Success.html';
    }
  }, 1000);
</script>

</body>
</html>

